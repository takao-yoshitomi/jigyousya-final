# 事業者管理アプリ開発 - Memory

## プロジェクト概要
Flask + PostgreSQL + JavaScript による事業者管理アプリケーション

## 現在の状況
- 年度確定機能（タスク項目のロック・継承・伝播）が完全に実装済み
- データ型整合性問題（bool vs object format）を解決済み
- バッチチェック機能の修正完了
- 初期データ作成ロジックの問題を特定済み

## 直近の作業内容
1. **データ型整合性問題の解決**
   - 特定のクライアント（101の7月/8月、103の7月）でタスクデータがbool型で保存される問題を発見
   - `{checked: boolean, note: string}` オブジェクト形式に統一
   - バッチチェック機能が正常に動作することを確認

2. **初期データ作成ロジックの問題特定**
   - `init-db` コマンドでの初期データ作成時にデータ型不整合が発生
   - 今後のデータベース初期化時に同様の問題を防ぐ必要がある

## 次回実装予定（ユーザー要望）
1. **排他制御（悲観ロック）の実装**
   - 詳細画面で複数ユーザーが同時アクセスした場合の排他制御
   - データベースレベルでの整合性保証

2. **項目の増減をデータベースに確実に反映**
   - カスタムタスク項目の追加・削除処理の安定化
   - フロントエンド-バックエンド間のデータ同期確実性向上

3. **デプロイ前の最終動作確認**
   - 全機能の統合テスト
   - 複数ユーザー環境での動作確認

## ユーザーの方針
- **安定性重視**: 複雑な機能追加よりも現在の機能の安定化を優先
- **デプロイ目標**: 基本機能が安定したらデプロイして実運用で改良を進める
- **実用性重視**: 実際に使いながらフィードバックを得て改善していく方針

## 技術スタック
- **Backend**: Python Flask, SQLAlchemy, Flask-Migrate, PostgreSQL
- **Frontend**: Vanilla JavaScript, HTML, CSS
- **Infrastructure**: Docker Compose
- **Database**: PostgreSQL with JSON columns for flexible data storage

## データベース構造
- **Client**: id, name, fiscal_month, staff_id, custom_tasks_by_year(JSON), finalized_years(JSON)
- **MonthlyTask**: client_id, month, tasks(JSON), status, url, memo
- **Staff**: id, name

## 重要な実装済み機能
1. **年度確定システム**: 特定年度のタスク項目をロック、編集不可にする
2. **タスク継承**: 新年度アクセス時に前年度のタスク項目を自動継承
3. **タスク伝播**: 項目変更時に未確定の将来年度に変更を伝播
4. **楽観ロック**: クライアント更新時の競合検出と防止
5. **カスタムタスク管理**: クライアントごとの独自タスク項目設定

## 現在のブランチ・コミット状況
- メインブランチ: main
- 最新コミット: データ型整合性修正とバッチチェック機能修正
- 安定版コミット: 82da825（年度確定基本機能動作確認済み）

## 次回セッション時の作業
1. 排他制御実装（悲観ロック）
2. データベース反映の確実性向上
3. デプロイ準備作業